graph LR
 %% Enforce black text across all nodes
 classDef process fill:#e3f2fd,stroke:#1565c0,stroke-width:1px,color:#000;
 classDef database fill:#fff9c4,stroke:#fbc02d,stroke-width:1px,color:#000;
 classDef aiModel fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:#000;
 classDef userIO fill:#fce4ec,stroke:#c2185b,stroke-width:1px,color:#000;
 classDef router fill:#ede7f6,stroke:#6a1b9a,stroke-width:2px,color:#000;
 classDef cache fill:#ffe0b2,stroke:#ef6c00,stroke-width:1px,color:#000;

 linkStyle default stroke:#424242,stroke-width:1.4px;
 linkStyle 0,1,2,3,4,5,6 stroke:#424242,stroke-width:1.4px;

 %% =========================================
 %% PHASE 1 ¬∑ KNOWLEDGE BASE (RIGHT SIDE)
 %% =========================================
 subgraph "PHASE 1 ¬∑ Offline Knowledge Preparation"
  direction TB

  subgraph "Input Sources"
    direction LR
    InputPDF[("üìú Unstructured Docs<br>(Policies, Schemes)")]:::database
    InputCSV[("üìä Structured Data<br>(Funding CSVs 2020-25)")]:::database
  end

  subgraph "Document Pipelines"
    direction TB
    ProcessSplit{Content Type?}:::router

    %% Table Path
    ProcessSplit -- "Tables" --> Tabula["Extract Table Structure<br>(Tabula-py / Img2Table)"]:::process
    Tabula --> TableMD["Normalize to Markdown / CSV"]:::process

    %% Text Path
    ProcessSplit -- "Text" --> OCR["OCR for Indic Languages<br>(Tesseract)"]:::process
    OCR --> CleanText["Clean ¬∑ Deduplicate ¬∑ Chunk"]:::process

    %% Shared Downstream
    TableMD & CleanText --> Embed["Generate Embeddings<br>(Sentence-Transformers)"]:::aiModel
  end

  subgraph "Knowledge Stores"
    direction TB
    Embed --> VectorDB[("üìÇ ChromaDB
Semantic Vector Index")]:::database
    TableMD & CleanText --> KWIndex[("üìù BM25 Index
Keyword Retrieval")]:::database
    CleanCSV["Data Cleaning ¬∑ Schema Harmonisation"]:::process
    CleanCSV --> PandasDB[("üìâ Pandas / SQLite Store
Structured Statistics")]:::database
  end

  %% Inputs feeding pipelines
  InputPDF --> ProcessSplit
  InputCSV --> CleanCSV
 end

 %% =========================================
 %% PHASE 2 ¬∑ USER INTERACTION (LEFT SIDE)
 %% =========================================
 subgraph "PHASE 2 ¬∑ Real-Time Offline Assistant"
  direction TB

  subgraph "Voice & Text Intake"
    direction LR
    UserMic("üé§ Voice Input<br>Hindi ¬∑ Marathi ¬∑ Hinglish"):::userIO --> Whisper["Offline STT<br>(Whisper Base)"]:::aiModel
    UserText("‚å®Ô∏è Text Input<br>Chat UI / Terminal"):::userIO --> LangQueue["Normalize Text
(Lowercase ¬∑ Punctuation)"]:::process
    Whisper --> IndicText["Indic Transcript"]:::process
    IndicText --> LangDetect{Language Detection}:::router
    LangQueue --> LangDetect
  end

  LangDetect -- "Non-English" --> TransIn["Translate to English<br>(EasyNMT Offline)"]:::aiModel
  LangDetect -- "English/Hinglish" --> EnglishQuery["Unified English Query"]:::process
  TransIn --> EnglishQuery

  subgraph "Smart Routing"
    direction TB
    EnglishQuery --> IntentRouter{"Intent Router<br>Rules ¬∑ Stats ¬∑ Lookup"}:::router
    IntentRouter -- "Eligibility ¬∑ Policies" --> HybridSearch["Hybrid Retrieval<br>Vector ‚äï Keyword"]:::process
    IntentRouter -- "Trends ¬∑ Numbers" --> DataAgent["Pandas Data Agent<br>(Auto SQL / Pandas Ops)"]:::process
    IntentRouter -- "Direct Fact" --> LookupCache["Cached Responses<br>(Recent / Pinned)"]:::cache
  end

  %% Retrieval wiring
  HybridSearch --> MergedResults["Merge ¬∑ Re-Rank ¬∑ Deduplicate"]:::process
  MergedResults --> ContextA["Policy Context Bundle"]:::process
  DataAgent --> PandasDB
  PandasDB --> ContextB["Exact Metrics / Tables"]:::process
  LookupCache --> ContextC["Fast Recall Snippets"]:::process

  %% Knowledge connections
  VectorDB -.-> HybridSearch
  KWIndex -.-> HybridSearch

  subgraph "Reasoning & Response"
    direction TB
    ContextA & ContextB & ContextC --> LlamaInput["Augmented Prompt"]:::process
    LlamaInput --> LlamaLLM["Local LLM Reasoning<br>(Llama 3 ¬∑ Mistral Q)"]:::aiModel
    LlamaLLM --> EngAnswer["Draft English Answer"]:::process
    EngAnswer --> Guardrails{Policy & Safety Guardrails}:::router
    Guardrails -- "Compliant" --> SafeAnswer["Approved Answer"]:::process
    Guardrails -- "Retry" --> LlamaInput
  end

  subgraph "Response Delivery"
    direction LR
    SafeAnswer --> TransOut["Translate back to Indic
(EasyNMT / MarianMT)"]:::aiModel
    SafeAnswer --> EnglishDisplay("üñ•Ô∏è English Transcript"):::userIO
    TransOut --> IndicTextOut["Indic Answer Text"]:::process
    IndicTextOut --> DisplayScreen("üì± UI / Dashboard"):::userIO
    IndicTextOut --> TTS["Offline TTS
(Sherpa-ONNX / VITS)"]:::aiModel
    TTS --> UserSpeaker("üîà Audio Output"):::userIO
  end
 end

 %% Cross-phase references (dashed)
 PandasDB -.-> DataAgent